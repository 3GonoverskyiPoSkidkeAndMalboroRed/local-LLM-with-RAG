# Функционал отображения источников в RAG

## Описание

Добавлен новый функционал для отображения источников информации в чате с RAG (Retrieval-Augmented Generation). Теперь при получении ответа от ИИ-ассистента пользователь может видеть, из каких документов была взята информация, и просматривать конкретные отрывки.

## Основные возможности

### 1. Отображение источников
- Показ названий файлов-источников
- Отображение предварительного просмотра отрывков
- Индикация релевантности (если доступно)
- Номера страниц (для PDF документов)

### 2. Детальный просмотр
- Развертывание полного текста отрывка
- Копирование текста в буфер обмена
- Скачивание отрывка как отдельного файла
- Модальное окно с детальной информацией

### 3. API для работы с источниками
- Новый эндпоинт `/llm/source/{task_id}/{chunk_id}` для получения деталей
- Расширенная структура ответа с информацией об источниках

## Техническая реализация

### Бэкенд

#### Новые модели данных (`server/routes/llm_routes.py`)

```python
class SourceInfo(BaseModel):
    """Информация об источнике документа"""
    file_name: str
    file_path: str
    chunk_content: str
    chunk_id: str
    page_number: Optional[int] = None
    similarity_score: Optional[float] = None

class QueryResultResponse(BaseModel):
    # ... существующие поля ...
    sources: List[SourceInfo] = []  # Детальная информация об источниках
```

#### Обновленная функция векторного поиска (`server/document_loader.py`)

- Возвращает детальную информацию о найденных документах
- Сохраняет метаданные (номера страниц, оценки релевантности)
- Улучшенная обработка результатов поиска

#### Новый API эндпоинт

```
GET /llm/source/{task_id}/{chunk_id}
```

Возвращает детальную информацию об источнике по ID задачи и ID фрагмента.

### Фронтенд

#### Компонент SourceDisplay (`vite-soft-ui-dashboard-main/src/components/SourceDisplay.vue`)

- Отображение списка источников
- Предварительный просмотр отрывков
- Кнопки для развертывания/сворачивания
- Интеграция с модальным окном

#### Компонент SourceModal (`vite-soft-ui-dashboard-main/src/components/SourceModal.vue`)

- Модальное окно с детальной информацией
- Полный текст отрывка
- Функции копирования и скачивания
- Метаданные источника

#### Обновленный чат (`vite-soft-ui-dashboard-main/src/views/Billing.vue`)

- Интеграция компонентов отображения источников
- Обработка событий от компонентов
- Уведомления пользователю

## Использование

### Для пользователей

1. **Отправьте вопрос в режиме RAG**
   - Выберите режим "С базой знаний (RAG)"
   - Введите ваш вопрос

2. **Просмотр источников**
   - После получения ответа под ним появятся источники
   - Нажмите "Показать полный текст" для развертывания отрывка
   - Нажмите "Детали" для открытия модального окна

3. **Работа с отрывками**
   - Копируйте текст в буфер обмена
   - Скачивайте отрывки как файлы
   - Просматривайте метаданные (номера страниц, релевантность)

### Для разработчиков

#### Тестирование функционала

```bash
# Запуск тестового скрипта
python test_rag_sources.py
```

#### API запросы

```bash
# Создание задачи
curl -X POST "http://localhost:8000/llm/query" \
  -H "Content-Type: application/json" \
  -d '{"question": "Ваш вопрос", "department_id": "5"}'

# Получение результата
curl "http://localhost:8000/llm/query/{task_id}"

# Получение деталей источника
curl "http://localhost:8000/llm/source/{task_id}/{chunk_id}"
```

## Структура ответа API

```json
{
  "task_id": "uuid",
  "status": "completed",
  "answer": "Ответ ИИ-ассистента",
  "chunks": ["фрагмент1", "фрагмент2"],
  "files": ["file1.pdf", "file2.docx"],
  "sources": [
    {
      "file_name": "document.pdf",
      "file_path": "/path/to/document.pdf",
      "chunk_content": "Полный текст отрывка...",
      "chunk_id": "chunk_task_id_0",
      "page_number": 5,
      "similarity_score": 0.85
    }
  ]
}
```

## Преимущества

1. **Прозрачность** - пользователи видят, откуда взята информация
2. **Доверие** - возможность проверить источники
3. **Удобство** - быстрый доступ к оригинальным отрывкам
4. **Гибкость** - различные способы работы с источниками

## Планы развития

- [ ] Добавление поиска по источникам
- [ ] Фильтрация источников по типу файлов
- [ ] Экспорт списка источников
- [ ] Интеграция с системой версионирования документов
- [ ] Аналитика использования источников

## Технические требования

- Python 3.8+
- Vue.js 3
- Bootstrap 5
- FastAPI
- ChromaDB для векторного поиска

## Устранение неполадок

### Проблемы с отображением источников

1. Проверьте, что отдел инициализирован с документами
2. Убедитесь, что векторный поиск возвращает результаты
3. Проверьте консоль браузера на ошибки JavaScript

### Проблемы с API

1. Проверьте логи сервера
2. Убедитесь, что задача завершена успешно
3. Проверьте доступность эндпоинтов

## Лицензия

Этот функционал является частью проекта local-LLM-with-RAG и распространяется под той же лицензией. 