# Requirements Document

## Introduction

Данная спецификация описывает миграцию системы RAG (Retrieval-Augmented Generation) с локального ИИ (Ollama) на использование API Yandex Cloud. Проект представляет собой многопользовательскую систему с поддержкой различных отделов, где каждый отдел имеет свою векторную базу данных и настройки доступа. Основные компоненты включают:

- **Backend**: FastAPI сервер с модульной архитектурой
- **LLM State Manager**: Централизованное управление состоянием ИИ моделей для отделов
- **Document Loader**: Система загрузки и индексации документов в векторную БД
- **Vector Database**: Chroma DB для хранения эмбеддингов документов
- **API Endpoints**: `/generate` (генерация без RAG) и `/query` (генерация с RAG)

Цель миграции - заменить локальные модели Ollama на облачные сервисы Yandex Cloud, включая LLM API, эмбеддинги и векторную базу данных, сохранив при этом существующую функциональность и архитектуру.

## Requirements

### Requirement 1: Миграция LLM модели на Yandex Cloud API

**User Story:** Как администратор системы, я хочу использовать LLM модели через API Yandex Cloud вместо локального Ollama, чтобы получить более стабильную и масштабируемую работу системы.

#### Acceptance Criteria

1. WHEN система инициализируется THEN она должна подключаться к Yandex Cloud Foundation Models API вместо локального Ollama
2. WHEN пользователь отправляет запрос на `/generate` THEN система должна использовать YandexGPT API для генерации ответа
3. WHEN система обрабатывает запрос THEN она должна поддерживать те же параметры генерации (temperature, max_tokens) что и в текущей реализации
4. IF API Yandex Cloud недоступен THEN система должна возвращать понятное сообщение об ошибке
5. WHEN система работает с несколькими отделами THEN каждый отдел должен использовать единый API ключ Yandex Cloud

### Requirement 2: Миграция системы эмбеддингов на Yandex Cloud

**User Story:** Как разработчик системы, я хочу использовать эмбеддинги Yandex Cloud вместо локальных моделей, чтобы обеспечить консистентность и производительность векторного поиска.

#### Acceptance Criteria

1. WHEN система создает эмбеддинги для документов THEN она должна использовать Yandex Cloud Embeddings API
2. WHEN выполняется векторный поиск THEN система должна использовать эмбеддинги, созданные через Yandex Cloud API
3. WHEN загружаются новые документы THEN система должна автоматически создавать эмбеддинги через Yandex Cloud
4. IF создание эмбеддинга не удается THEN система должна логировать ошибку и продолжить работу с другими документами
5. WHEN система обрабатывает запрос пользователя THEN она должна создавать эмбеддинг запроса через тот же API

### Requirement 3: Интеграция с Yandex Cloud Vector Database (если доступна)

**User Story:** Как архитектор системы, я хочу использовать облачную векторную базу данных Yandex Cloud вместо локальной Chroma DB, чтобы улучшить масштабируемость и надежность системы.

#### Acceptance Criteria

1. IF Yandex Cloud предоставляет векторную БД THEN система должна мигрировать с Chroma на облачное решение
2. WHEN система выполняет векторный поиск THEN она должна использовать API облачной векторной БД
3. WHEN система сохраняет эмбеддинги THEN они должны храниться в облачной векторной БД
4. IF облачная векторная БД недоступна THEN система должна продолжать использовать локальную Chroma с облачными эмбеддингами
5. WHEN происходит миграция данных THEN существующие векторы должны быть перенесены без потери данных

### Requirement 4: Обновление конфигурации и аутентификации

**User Story:** Как администратор системы, я хочу настроить аутентификацию с Yandex Cloud через переменные окружения, чтобы обеспечить безопасное подключение к облачным сервисам.

#### Acceptance Criteria

1. WHEN система запускается THEN она должна читать API ключи Yandex Cloud из переменных окружения
2. WHEN система подключается к Yandex Cloud THEN она должна использовать правильные заголовки аутентификации
3. WHEN происходит ошибка аутентификации THEN система должна логировать детальную информацию об ошибке
4. IF API ключ отсутствует или неверен THEN система должна выдавать понятное сообщение об ошибке при инициализации
5. WHEN система работает в production THEN все чувствительные данные должны передаваться через переменные окружения

### Requirement 5: Сохранение совместимости API

**User Story:** Как разработчик фронтенда, я хочу чтобы существующие API эндпоинты продолжали работать без изменений, чтобы не нарушить работу клиентских приложений.

#### Acceptance Criteria

1. WHEN клиент отправляет запрос на `/llm/generate` THEN эндпоинт должен работать с теми же параметрами запроса и ответа
2. WHEN клиент отправляет запрос на `/llm/query` THEN эндпоинт должен возвращать результаты в том же формате
3. WHEN система обрабатывает асинхронные запросы THEN механизм task_id и статусов должен остаться неизменным
4. WHEN происходит ошибка THEN формат сообщений об ошибках должен соответствовать текущему API
5. IF требуются новые параметры THEN они должны быть опциональными для обратной совместимости

### Requirement 6: Обработка ошибок и мониторинг

**User Story:** Как администратор системы, я хочу получать детальную информацию об ошибках при работе с Yandex Cloud API, чтобы быстро диагностировать и решать проблемы.

#### Acceptance Criteria

1. WHEN происходит ошибка API Yandex Cloud THEN система должна логировать HTTP статус код и детали ошибки
2. WHEN превышается лимит запросов THEN система должна реализовать retry механизм с экспоненциальной задержкой
3. WHEN API недоступен THEN система должна переключаться в режим graceful degradation
4. IF происходит таймаут запроса THEN система должна возвращать соответствующее сообщение пользователю
5. WHEN система работает THEN она должна отслеживать метрики использования API (количество запросов, время ответа)

### Requirement 7: Оптимизация производительности и затрат

**User Story:** Как владелец продукта, я хочу оптимизировать использование API Yandex Cloud, чтобы минимизировать затраты при сохранении качества работы системы.

#### Acceptance Criteria

1. WHEN система создает эмбеддинги THEN она должна кэшировать результаты для повторно используемых документов
2. WHEN выполняется векторный поиск THEN система должна ограничивать количество возвращаемых результатов разумным числом
3. WHEN обрабатывается запрос пользователя THEN система должна использовать оптимальные параметры модели для баланса качества и скорости
4. IF документ уже обработан THEN система не должна повторно создавать эмбеддинги
5. WHEN система работает под нагрузкой THEN она должна эффективно управлять пулом соединений к API

### Requirement 8: Тестирование и валидация

**User Story:** Как QA инженер, я хочу убедиться что миграция на Yandex Cloud не нарушила существующую функциональность системы.

#### Acceptance Criteria

1. WHEN выполняются существующие тесты THEN они должны проходить с новой реализацией
2. WHEN сравнивается качество ответов THEN результаты Yandex Cloud должны быть сопоставимы с Ollama
3. WHEN тестируется производительность THEN время ответа должно быть приемлемым для пользователей
4. IF происходит регрессия функциональности THEN должны быть созданы дополнительные тесты для покрытия
5. WHEN система развертывается THEN должны быть доступны smoke тесты для проверки интеграции с Yandex Cloud