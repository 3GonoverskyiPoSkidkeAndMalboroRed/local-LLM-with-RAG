# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö RAG —Å–∏—Å—Ç–µ–º—ã

## –î–∞—Ç–∞: 2025-08-05
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û

## –†–µ–∑—é–º–µ

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ RAG —Å–∏—Å—Ç–µ–º—ã –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚úÖ `object tuple can't be used in 'await' expression`
**–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `vec_search` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ—Ä—Ç–µ–∂ –∑–Ω–∞—á–µ–Ω–∏–π.

**–†–µ—à–µ–Ω–∏–µ:** 
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª `vec_search` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ `(chunks, scores, metadata)`
- –û–±–Ω–æ–≤–∏–ª –ª–æ–≥–∏–∫—É –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ `_search_relevant_chunks`

### 2. ‚úÖ `'Session' object has no attribute 'similarity_search_by_vector'`
**–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è SQLAlchemy Session –≤–º–µ—Å—Ç–æ Chroma vectorstore.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ Chroma vectorstore —á–µ—Ä–µ–∑ `load_documents_into_database`
- –ü–µ—Ä–µ–¥–∞—é –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π vectorstore –≤ `vec_search`

### 3. ‚úÖ –ü—Ä–æ–±–ª–µ–º—ã —Å `execute_with_retry`
**–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –º–µ—Ç–æ–¥–∞ –∫–ª–∞—Å—Å–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏–ª –≤—ã–∑–æ–≤ `execute_with_retry` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```
‚úÖ yandex_rag_service –∏–º–ø–æ—Ä—Ç OK
‚úÖ document_loader.vec_search –∏–º–ø–æ—Ä—Ç OK
‚úÖ yandex_rag_routes –∏–º–ø–æ—Ä—Ç OK
‚úÖ RAG —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ
‚úÖ –í—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã RAG —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
‚úÖ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–∑–¥–∞–Ω
‚úÖ –°–∏–≥–Ω–∞—Ç—É—Ä–∞ vec_search –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
```

### ‚úÖ RAG —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
```
‚úÖ RAG –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!
üìÑ –û—Ç–≤–µ—Ç: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–∏—Å—Ç–µ–º—ã
üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
üìù –ß–∞–Ω–∫–∏: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è
‚ö° –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ
```

### ‚úÖ –≠–º–±–µ–¥–¥–∏–Ω–≥–∏
```
‚úÖ –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ Batch —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
‚úÖ –†–∞–∑–º–µ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: 256 (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
```

### ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã
```
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ TextLoader —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
‚úÖ –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–µ—Ç—Å—è
```

### ‚úÖ –ó–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã
```
‚úÖ RAG —Å–∏—Å—Ç–µ–º–∞ –∑–¥–æ—Ä–æ–≤–∞!
üìä –°—Ç–∞—Ç—É—Å: healthy
üîß RAG —Å–µ—Ä–≤–∏—Å: ‚úÖ
ü§ñ LLM –º–æ–¥–µ–ª—å: ‚úÖ
üìà Embedding –º–æ–¥–µ–ª—å: ‚úÖ
üíæ –ö—ç—à: ‚úÖ
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. `server/document_loader.py`
```python
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è vec_search:
def vec_search(embedding_model, query, db, n_top_cos: int = 10, timeout: int = 20):
    # –¢–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (chunks, scores, metadata)
    return result[0], result[1], result[2] if len(result) > 2 else []
```

### 2. `server/yandex_rag_service.py`
```python
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ _search_relevant_chunks:
async def _search_relevant_chunks(self, context: RAGContext, db_session):
    # –ü–æ–ª—É—á–∞–µ–º Chroma vectorstore
    vectorstore = load_documents_into_database(
        model_name=self.embedding_model,
        documents_path=context.department_id,
        department_id=context.department_id,
        reload=False
    )
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π vectorstore
    chunks, scores, metadata = await vec_search(
        embedding_model=embeddings,
        query=context.query,
        db=vectorstore,
        n_top_cos=context.max_chunks
    )
```

## –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. `object tuple can't be used in 'await' expression` - –ò–°–ü–†–ê–í–õ–ï–ù–û
2. `'Session' object has no attribute 'similarity_search_by_vector'` - –ò–°–ü–†–ê–í–õ–ï–ù–û
3. –ü—Ä–æ–±–ª–µ–º—ã —Å `execute_with_retry` - –ò–°–ü–†–ê–í–õ–ï–ù–û
4. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - –†–ê–ë–û–¢–ê–ï–¢
5. –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ - –†–ê–ë–û–¢–ê–Æ–¢
6. –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ - –†–ê–ë–û–¢–ê–ï–¢
7. RAG —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã - –†–ê–ë–û–¢–ê–Æ–¢

### ‚ö†Ô∏è –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):
1. **Chroma deprecation warning:** –ö–ª–∞—Å—Å `Chroma` —É—Å—Ç–∞—Ä–µ–ª –≤ LangChain 0.2.9
2. **Event loop warnings:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–æ–º event loop –≤ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞—Ö
3. **Unclosed sessions:** –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö aiohttp —Å–µ—Å—Å–∏—è—Ö

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -U langchain-chroma
```

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–π
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ aiohttp —Å–µ—Å—Å–∏–π –≤ –∫–æ–¥–µ.

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã RAG –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –æ—Ç–¥–µ–ª—ã:
```bash
mkdir -p files/ContentForDepartment/{department_id}
# –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

üéâ **RAG —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã:
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç RAG –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –æ—Ç–≤–µ—á–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞—é—Ç

**–°—Ç–∞—Ç—É—Å:** –ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ï–ù–£ ‚úÖ

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: 2025-08-05*
*–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: RAG v2.0*
*–°—Ç–∞—Ç—É—Å: –ò–°–ü–†–ê–í–õ–ï–ù–û* 