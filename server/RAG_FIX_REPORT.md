# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö RAG —Å–∏—Å—Ç–µ–º—ã

## –î–∞—Ç–∞: 2025-08-05
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. –û—à–∏–±–∫–∞: `object tuple can't be used in 'await' expression`

**–ü—Ä–∏—á–∏–Ω–∞:** –§—É–Ω–∫—Ü–∏—è `vec_search` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –∫–æ—Ä—Ç–µ–∂ `(chunks, files, detailed_results)`, –Ω–æ –≤ `_search_relevant_chunks` –æ–∂–∏–¥–∞–ª—Å—è –∫–æ—Ä—Ç–µ–∂ `(chunks, scores, metadata)`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏—é `vec_search` –≤ `document_loader.py` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ò–∑–º–µ–Ω–∏–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ `(chunks, scores, metadata)`
- –û–±–Ω–æ–≤–∏–ª –ª–æ–≥–∏–∫—É –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å scores

### 2. –û—à–∏–±–∫–∞: `'Session' object has no attribute 'similarity_search_by_vector'`

**–ü—Ä–∏—á–∏–Ω–∞:** –í —Ñ—É–Ω–∫—Ü–∏—é `vec_search` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è SQLAlchemy Session –≤–º–µ—Å—Ç–æ Chroma vectorstore.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª –º–µ—Ç–æ–¥ `_search_relevant_chunks` –≤ `yandex_rag_service.py`
- –î–æ–±–∞–≤–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ Chroma vectorstore —á–µ—Ä–µ–∑ `load_documents_into_database`
- –ü–µ—Ä–µ–¥–∞—é –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π vectorstore –≤ —Ñ—É–Ω–∫—Ü–∏—é `vec_search`

### 3. –ü—Ä–æ–±–ª–µ–º–∞ —Å `execute_with_retry`

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –º–µ—Ç–æ–¥–∞ –∫–ª–∞—Å—Å–∞ –≤ `execute_with_retry`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ò—Å–ø—Ä–∞–≤–∏–ª –≤—ã–∑–æ–≤ `execute_with_retry` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ—Ç–æ–¥–∞ –∫–ª–∞—Å—Å–∞

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

### 1. `server/document_loader.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `vec_search`:**
```python
# –ë—ã–ª–æ:
return result[0], result[1], result[2] if len(result) > 2 else []

# –°—Ç–∞–ª–æ:
return result[0], result[1], result[2] if len(result) > 2 else []
```

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ scores:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `similarity_search_with_score` –≤–º–µ—Å—Ç–æ `similarity_search_by_vector`
- –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ scores –≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Ç–∏–≤–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –£–ª—É—á—à–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ score

### 2. `server/yandex_rag_service.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–µ `_search_relevant_chunks`:**
```python
# –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ Chroma vectorstore:
from document_loader import load_documents_into_database

vectorstore = load_documents_into_database(
    model_name=self.embedding_model,
    documents_path=context.department_id,
    department_id=context.department_id,
    reload=False
)

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ vec_search:
chunks, scores, metadata = await vec_search(
    embedding_model=embeddings,
    query=context.query,
    db=vectorstore,  # –ü–µ—Ä–µ–¥–∞–µ–º Chroma vectorstore
    n_top_cos=context.max_chunks
)
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```
‚úÖ yandex_rag_service –∏–º–ø–æ—Ä—Ç OK
‚úÖ document_loader.vec_search –∏–º–ø–æ—Ä—Ç OK
‚úÖ yandex_rag_routes –∏–º–ø–æ—Ä—Ç OK
‚úÖ RAG —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ
‚úÖ –í—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã RAG —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
‚úÖ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–∑–¥–∞–Ω
‚úÖ –°–∏–≥–Ω–∞—Ç—É—Ä–∞ vec_search –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
```

### –¢–µ—Å—Ç 2: RAG —ç–Ω–¥–ø–æ–∏–Ω—Ç
```
‚úÖ RAG –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!
üìÑ –û—Ç–≤–µ—Ç: –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏: 0
üìù –ß–∞–Ω–∫–∏: 0
‚ö° –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 1.00—Å
```

### –¢–µ—Å—Ç 3: –ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RAG —Å–µ—Ä–≤–∏—Å–∞
```
‚úÖ RAG –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!
üìÑ –û—Ç–≤–µ—Ç: –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏: 0
üìù –ß–∞–Ω–∫–∏: 0
‚ö° –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 0.02—Å
```

### –¢–µ—Å—Ç 4: –ú–µ—Ç—Ä–∏–∫–∏ RAG
```
‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ RAG –ø–æ–ª—É—á–µ–Ω—ã:
  total_queries: 2
  successful_queries: 2
  failed_queries: 0
  success_rate: 1.0
  average_response_time: 0.5073995
  average_chunks_used: 0.0
  cache_hit_rate: 0.0
  model_used: yandexgpt
  embedding_model: text-search-doc
```

## –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. `object tuple can't be used in 'await' expression` - –ò–°–ü–†–ê–í–õ–ï–ù–û
2. `'Session' object has no attribute 'similarity_search_by_vector'` - –ò–°–ü–†–ê–í–õ–ï–ù–û
3. –ü—Ä–æ–±–ª–µ–º—ã —Å `execute_with_retry` - –ò–°–ü–†–ê–í–õ–ï–ù–û

### ‚ö†Ô∏è –ó–∞–º–µ—á–∞–Ω–∏—è:
1. **–ü—É—Å—Ç–∞—è –±–∞–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** –í –æ—Ç–¥–µ–ª–µ "5" –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –ø–æ—ç—Ç–æ–º—É RAG –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ —Ç–æ–º, —á—Ç–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

2. **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ Chroma:** –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–ª–∞—Å—Å `Chroma` —É—Å—Ç–∞—Ä–µ–ª –≤ LangChain 0.2.9. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ `langchain-chroma`.

3. **–ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å–µ—Å—Å–∏–∏:** –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö aiohttp —Å–µ—Å—Å–∏—è—Ö. –≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å.

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã RAG –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –æ—Ç–¥–µ–ª:
```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
mkdir -p files/ContentForDepartment/5

# –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
echo "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç." > files/ContentForDepartment/5/test.txt
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Chroma
```bash
pip install -U langchain-chroma
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–π
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ aiohttp —Å–µ—Å—Å–∏–π –≤ –∫–æ–¥–µ.

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ RAG —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç RAG –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ edge cases

RAG —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ 