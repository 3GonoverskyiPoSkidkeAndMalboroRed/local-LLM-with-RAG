# Система автоматической загрузки файлов

## Обзор

Система загрузки файлов была переработана для автоматического формирования пути к файлам на основе ID отдела. Теперь пользователям не нужно вручную указывать путь к файлу - система автоматически создает структуру директорий и сохраняет файлы в соответствующих папках.

## Как это работает

### Автоматическое формирование пути

При загрузке файла система автоматически формирует путь по следующему шаблону:
```
/app/files/ContentForDepartment/{department_id}/{filename}
```

**Примеры:**
- Отдел ID: 5 → `/app/files/ContentForDepartment/5/document.pdf`
- Отдел ID: 10 → `/app/files/ContentForDepartment/10/report.docx`
- Отдел ID: 25 → `/app/files/ContentForDepartment/25/presentation.pptx`

### Процесс загрузки

1. **Пользователь выбирает файлы** в веб-интерфейсе
2. **Указывает ID отдела** (обязательное поле)
3. **Указывает уровень доступа** (обязательное поле)
4. **Система автоматически:**
   - Создает директорию `/app/files/ContentForDepartment/{department_id}/` если она не существует
   - Сохраняет файлы в эту директорию
   - Записывает информацию о файлах в базу данных с полным путем

## API Эндпоинты

### 1. Загрузка одного файла с метаданными
```
POST /content/upload-content
```

**Параметры:**
- `title` (str) - Название контента
- `description` (str) - Описание контента
- `access_id` (int) - ID уровня доступа
- `department_id` (int) - ID отдела (определяет путь)
- `file` (UploadFile) - Файл для загрузки
- `tag_id` (int, optional) - ID тега

### 2. Загрузка нескольких файлов
```
POST /content/upload-files
```

**Параметры:**
- `files` (List[UploadFile]) - Список файлов
- `access_level` (int) - Уровень доступа (по умолчанию: 1)
- `department_id` (int) - ID отдела (по умолчанию: 1)

## Веб-интерфейс

### Форма загрузки файлов

В интерфейсе пользователь видит:
- **Поле "Уровень доступа"** - для указания уровня доступа к файлам
- **Поле "Идентификатор отдела"** - для указания ID отдела
- **Поле "Файлы для загрузки"** - для выбора файлов
- **Подсказка** - "Файлы будут автоматически сохранены в папку ContentForDepartment/{ID отдела}"

### Пример использования

1. Пользователь вводит ID отдела: `5`
2. Выбирает уровень доступа: `1`
3. Выбирает файлы: `document.pdf`, `report.docx`
4. Нажимает "Загрузить файлы"
5. Система автоматически:
   - Создает директорию `/app/files/ContentForDepartment/5/`
   - Сохраняет файлы:
     - `/app/files/ContentForDepartment/5/document.pdf`
     - `/app/files/ContentForDepartment/5/report.docx`
   - Записывает информацию в БД

## Структура директорий

```
/app/files/
├── ContentForDepartment/
│   ├── 1/
│   │   ├── file1.pdf
│   │   └── file2.docx
│   ├── 5/
│   │   ├── document.pdf
│   │   └── report.docx
│   ├── 10/
│   │   └── presentation.pptx
│   └── 25/
│       └── manual.txt
└── other_directories/
```

## Преимущества новой системы

1. **Упрощение процесса** - пользователям не нужно вручную указывать пути
2. **Автоматическая организация** - файлы автоматически группируются по отделам
3. **Предотвращение ошибок** - исключена возможность указания неправильного пути
4. **Консистентность** - все файлы отдела хранятся в одной директории
5. **Масштабируемость** - легко добавлять новые отделы

## Обратная совместимость

Система полностью совместима с существующими файлами. Старые записи в базе данных продолжают работать, а новые файлы сохраняются по новой схеме.

## Тестирование

Для тестирования системы создан скрипт `test_upload_system.py`, который проверяет:
- Автоматическое формирование путей
- Создание директорий
- Корректность структуры

Запуск теста:
```bash
python test_upload_system.py
```

## Безопасность

- Все пути проверяются на безопасность
- Файлы сохраняются только в разрешенных директориях
- Поддерживается система уровней доступа
- Проверка существования отдела перед сохранением файла 