# Система автоматической загрузки файлов и инициализации LLM

## Обзор

Система была переработана для автоматического формирования пути к файлам и инициализации LLM на основе ID отдела. Теперь пользователям не нужно вручную указывать пути - система автоматически создает структуру директорий, сохраняет файлы и инициализирует LLM для соответствующих отделов.

## Как это работает

### Автоматическое формирование пути

При загрузке файла система автоматически формирует путь по следующему шаблону:
```
/app/files/ContentForDepartment/{department_id}/{filename}
```

**Примеры:**
- Отдел ID: 5 → `/app/files/ContentForDepartment/5/document.pdf`
- Отдел ID: 10 → `/app/files/ContentForDepartment/10/report.docx`
- Отдел ID: 25 → `/app/files/ContentForDepartment/25/presentation.pptx`

### Процесс загрузки файлов

1. **Пользователь выбирает файлы** в веб-интерфейсе
2. **Указывает ID отдела** (обязательное поле)
3. **Указывает уровень доступа** (обязательное поле)
4. **Система автоматически:**
   - Создает директорию `/app/files/ContentForDepartment/{department_id}/` если она не существует
   - Сохраняет файлы в эту директорию
   - Записывает информацию о файлах в базу данных с полным путем

### Процесс инициализации LLM

1. **Пользователь указывает модель LLM** и модель эмбеддингов
2. **Указывает ID отдела** (обязательное поле)
3. **Система автоматически:**
   - Использует ID отдела как путь к документам
   - Загружает документы из `/app/files/ContentForDepartment/{department_id}/`
   - Создает векторную базу данных для отдела
   - Инициализирует LLM с загруженными документами

## API Эндпоинты

### 1. Загрузка одного файла с метаданными
```
POST /content/upload-content
```

**Параметры:**
- `title` (str) - Название контента
- `description` (str) - Описание контента
- `access_id` (int) - ID уровня доступа
- `department_id` (int) - ID отдела (определяет путь)
- `file` (UploadFile) - Файл для загрузки
- `tag_id` (int, optional) - ID тега

### 2. Загрузка нескольких файлов
```
POST /content/upload-files
```

**Параметры:**
- `files` (List[UploadFile]) - Список файлов
- `access_level` (int) - Уровень доступа (по умолчанию: 1)
- `department_id` (int) - ID отдела (по умолчанию: 1)

### 3. Инициализация LLM
```
POST /llm/initialize
```

**Параметры:**
- `model_name` (str) - Название модели LLM
- `embedding_model_name` (str) - Название модели эмбеддингов
- `documents_path` (str) - Автоматически устанавливается равным ID отдела
- `department_id` (str) - ID отдела

## Веб-интерфейс

### Форма загрузки файлов

В интерфейсе пользователь видит:
- **Поле "Уровень доступа"** - для указания уровня доступа к файлам
- **Поле "Идентификатор отдела"** - для указания ID отдела
- **Поле "Файлы для загрузки"** - для выбора файлов
- **Подсказка** - "Файлы будут автоматически сохранены в папку ContentForDepartment/{ID отдела}"

### Форма инициализации LLM

В интерфейсе пользователь видит:
- **Поле "Модель LLM"** - для указания модели LLM
- **Поле "Модель эмбеддингов"** - для указания модели эмбеддингов
- **Поле "Идентификатор отдела"** - для указания ID отдела
- **Подсказка** - "Документы будут автоматически загружены из папки ContentForDepartment/{ID отдела}"

### Пример использования

1. **Загрузка файлов:**
   - Пользователь вводит ID отдела: `5`
   - Выбирает уровень доступа: `1`
   - Выбирает файлы: `document.pdf`, `report.docx`
   - Нажимает "Загрузить файлы"
   - Система автоматически:
     - Создает директорию `/app/files/ContentForDepartment/5/`
     - Сохраняет файлы:
       - `/app/files/ContentForDepartment/5/document.pdf`
       - `/app/files/ContentForDepartment/5/report.docx`
     - Записывает информацию в БД

2. **Инициализация LLM:**
   - Пользователь вводит модель LLM: `llama2`
   - Вводит модель эмбеддингов: `nomic-embed-text`
   - Вводит ID отдела: `5`
   - Нажимает "Инициализировать LLM"
   - Система автоматически:
     - Загружает документы из `/app/files/ContentForDepartment/5/`
     - Создает векторную базу данных для отдела 5
     - Инициализирует LLM с загруженными документами

## Структура директорий

```
/app/files/
├── ContentForDepartment/
│   ├── 1/
│   │   ├── file1.pdf
│   │   └── file2.docx
│   ├── 5/
│   │   ├── document.pdf
│   │   └── report.docx
│   ├── 10/
│   │   └── presentation.pptx
│   └── 25/
│       └── manual.txt
└── other_directories/
```

## Преимущества новой системы

1. **Упрощение процесса** - пользователям не нужно вручную указывать пути
2. **Автоматическая организация** - файлы автоматически группируются по отделам
3. **Предотвращение ошибок** - исключена возможность указания неправильного пути
4. **Консистентность** - все файлы отдела хранятся в одной директории
5. **Масштабируемость** - легко добавлять новые отделы
6. **Автоматическая инициализация LLM** - LLM автоматически загружает документы из правильной папки

## Обратная совместимость

Система полностью совместима с существующими файлами. Старые записи в базе данных продолжают работать, а новые файлы сохраняются по новой схеме.

## Тестирование

Для тестирования системы создан скрипт `test_upload_system.py`, который проверяет:
- Автоматическое формирование путей
- Создание директорий
- Корректность структуры

Запуск теста:
```bash
python test_upload_system.py
```

## Безопасность

- Все пути проверяются на безопасность
- Файлы сохраняются только в разрешенных директориях
- Поддерживается система уровней доступа
- Проверка существования отдела перед сохранением файла 