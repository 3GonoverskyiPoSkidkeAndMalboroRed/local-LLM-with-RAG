# Система ролей доступа

## Описание ролей

### 1. Админ (role_id = 1)
**Полные права на управление системой:**

- **Управление пользователями:**
  - Создание пользователей (регистрация)
  - Удаление пользователей
  - Редактирование пользователей (логин, пароль, роль, отдел, уровень доступа)

- **Управление контентом:**
  - Добавление контента
  - Редактирование контента (отдел, уровень доступа, название, описание, удаление)
  - Видимость всех документов

- **Управление LLM:**
  - Инициализация LLM
  - Создание директории файлов
  - Загрузка файлов
  - Просмотр файлов

- **Система обратной связи:**
  - Просмотр всех сообщений обратной связи

### 2. Пользователь (role_id = 2)
**Базовые права для работы с контентом:**

- Просмотр контента (согласно уровню доступа и отделу)
- Скачивание контента
- Прохождение тестов и анкет
- Отправка сообщений обратной связи
- Авторизация в системе

### 3. Глава отдела (role_id = 3)
**Права на управление своим отделом:**

- **Управление пользователями:**
  - Создание аккаунтов (только с ролью "Пользователь")
  - Только для своего отдела

- **Управление контентом:**
  - Одобрение загрузки контента (система предложения-одобрения)
  - Только для своего отдела
  - Редактирование контента (только для своего отдела)
  - Видимость всех документов только для своего отдела

### 4. Ответственный отдела (role_id = 4)
**Права на предложение контента:**

- Просмотр контента (согласно уровню доступа и отделу)
- Скачивание контента
- Прохождение тестов и анкет
- Отправка сообщений обратной связи
- Авторизация в системе
- **Предложение контента для загрузки:**
  - Прописывает название, описание, уровень доступа, тег

## Система предложений контента

### Процесс создания контента:

1. **Ответственный отдела** создает предложение контента
   - Указывает название, описание, уровень доступа, тег
   - Предложение получает статус "pending"

2. **Глава отдела** или **Админ** рассматривает предложение
   - Может одобрить (status = "approved")
   - Может отклонить (status = "rejected")
   - Может добавить комментарий к решению

3. **При одобрении** автоматически создается запись в таблице контента
   - Файл должен быть загружен отдельно
   - Контент получает статус "active"

### API эндпоинты для предложений:

- `POST /proposals/` - Создание предложения
- `GET /proposals/` - Получение списка предложений
- `GET /proposals/{id}` - Получение конкретного предложения
- `PUT /proposals/{id}/review` - Рассмотрение предложения
- `DELETE /proposals/{id}` - Удаление предложения

## Проверка прав доступа

### Модуль `utils/permissions.py`

Содержит класс `PermissionChecker` с методами для проверки прав:

```python
# Проверка ролей
PermissionChecker.is_admin(user)
PermissionChecker.is_department_head(user)
PermissionChecker.is_department_responsible(user)
PermissionChecker.is_regular_user(user)

# Проверка прав
PermissionChecker.can_manage_users(user, target_user)
PermissionChecker.can_manage_content(user, content)
PermissionChecker.can_view_content(user, content)
PermissionChecker.can_propose_content(user)
PermissionChecker.can_review_proposals(user, proposal)
PermissionChecker.can_manage_llm(user)
PermissionChecker.can_view_feedback(user)
PermissionChecker.can_send_feedback(user)
PermissionChecker.can_take_quizzes(user)
PermissionChecker.can_create_quizzes(user)

# Получение информации
PermissionChecker.get_user_role_name(user)
PermissionChecker.get_user_permissions(user)
```

## Обновленные API эндпоинты

### Пользователи:
- `GET /user/me` - теперь возвращает информацию о роли и разрешениях
- `GET /user/permissions` - получение разрешений пользователя
- `GET /users` - фильтрация по правам доступа
- `POST /user/register` - проверка прав на создание пользователей

### Контент:
- Обновлена проверка доступа к документам
- Добавлена поддержка новых ролей

## Миграция базы данных

### Файл `migrations/update_roles_system.py`

Выполняет следующие изменения:

1. **Обновление таблицы ролей:**
   - Добавление новых ролей (Глава отдела, Ответственный отдела)

2. **Создание таблицы предложений:**
   - `content_proposals` - для системы предложения-одобрения

3. **Обновление таблицы контента:**
   - Добавление поля `creator_id` - ID создателя контента
   - Добавление поля `status` - статус контента
   - Добавление полей `created_at`, `updated_at`

## Тестовые данные

### Новые пользователи:

- `head_it` / `head123` - Глава IT отдела
- `head_hr` / `head123` - Глава HR отдела  
- `resp_it` / `resp123` - Ответственный IT отдела
- `resp_hr` / `resp123` - Ответственный HR отдела

## Безопасность

- Все эндпоинты защищены аутентификацией
- Проверка прав доступа на уровне API
- Rate limiting для предотвращения злоупотреблений
- Логирование попыток несанкционированного доступа
