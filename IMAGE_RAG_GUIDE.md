# Руководство по RAG системе с поддержкой изображений

## Обзор

Система RAG (Retrieval-Augmented Generation) была улучшена для поддержки работы с изображениями в документах. Теперь при запросах в чате система может извлекать и отображать изображения из документов вместе с текстовыми ответами.

## Новые возможности

### 1. Извлечение изображений из документов
- **PDF документы**: Извлекаются все изображения со всех страниц
- **DOCX документы**: Извлекаются вставленные изображения
- **Отдельные изображения**: Поддерживаются форматы JPG, PNG, GIF, BMP, TIFF, WebP

### 2. Отображение изображений в чате
- Миниатюры изображений в ответах
- Модальные окна для просмотра в полном размере
- Информация о контексте изображений
- Возможность скачивания изображений

### 3. Улучшенные ответы ИИ
- ИИ учитывает наличие изображений в документах
- Упоминает изображения в ответах
- Предоставляет контекст для изображений

## Техническая реализация

### База данных
- Добавлено поле `images` в таблицу `document_chunks`
- Хранение изображений в формате JSON с base64 кодировкой
- Метаданные изображений (тип, страница, контекст)

### Компоненты системы

#### 1. ImageExtractor (`server/utils/image_extractor.py`)
```python
class ImageExtractor:
    def extract_images_from_file(self, file_path: str, chunk_text: str = "") -> List[Dict[str, Any]]
    def get_images_for_chunk(self, content_id: int, department_id: int, chunk_text: str) -> List[Dict[str, Any]]
```

#### 2. Модифицированный RAG сервис
- Извлечение изображений при создании чанков
- Включение изображений в источники ответов
- Обновленный промпт для ИИ

#### 3. Frontend компоненты
- `ImageDisplay.vue` - отображение изображений
- Обновленный `SourceDisplay.vue` - включение изображений в источники

## Использование

### 1. Загрузка документов с изображениями
Документы с изображениями загружаются обычным способом через интерфейс загрузки контента.

### 2. Инициализация RAG
При инициализации RAG системы изображения автоматически извлекаются и сохраняются в базе данных.

### 3. Запросы в чате
При запросах система:
1. Находит релевантные чанки документов
2. Извлекает связанные изображения
3. Формирует ответ с учетом изображений
4. Отображает изображения в интерфейсе

### 4. Просмотр изображений
- Клик по миниатюре открывает модальное окно
- В модальном окне показывается полное изображение
- Отображается контекст изображения
- Доступна функция скачивания

## Поддерживаемые форматы

### Входные документы
- **PDF**: Все изображения со всех страниц
- **DOCX**: Вставленные изображения
- **Изображения**: JPG, JPEG, PNG, GIF, BMP, TIFF, WebP

### Выходные данные
- **Base64 кодировка**: Для отображения в браузере
- **Метаданные**: Тип, страница, контекст, имя файла
- **Контекст**: Текст вокруг изображения

## Конфигурация

### Переменные окружения
```bash
RAG_CHUNK_SIZE=2000        # Размер чанка в символах
RAG_CHUNK_OVERLAP=400      # Перекрытие между чанками
```

### Настройки изображений
- Максимальный размер изображения: определяется настройками сервера
- Качество сжатия: PNG для PDF, оригинальное для других форматов
- Контекст: первые 200 символов текста чанка

## Производительность

### Оптимизации
- Ленивая загрузка изображений
- Сжатие изображений для миниатюр
- Кэширование в браузере
- Асинхронная обработка

### Ограничения
- Размер изображений влияет на время обработки
- Большие документы с множеством изображений требуют больше времени
- Память: изображения хранятся в base64 формате

## Примеры использования

### Запрос: "Покажи диаграммы из документа"
Система найдет документы с диаграммами и отобразит их вместе с ответом.

### Запрос: "Какие изображения есть в инструкции?"
Система перечислит все изображения из инструкции с их контекстом.

### Запрос: "Схема подключения"
Система найдет схемы подключения и покажет их с описанием.

## Устранение неполадок

### Изображения не отображаются
1. Проверьте, что документ содержит изображения
2. Убедитесь, что RAG система переинициализирована
3. Проверьте логи сервера на ошибки извлечения

### Медленная загрузка
1. Уменьшите размер изображений в документах
2. Проверьте настройки сжатия
3. Увеличьте ресурсы сервера

### Ошибки извлечения
1. Проверьте формат документа
2. Убедитесь в наличии необходимых библиотек
3. Проверьте права доступа к файлам

## Будущие улучшения

1. **OCR для изображений**: Извлечение текста из изображений
2. **Анализ изображений**: Использование ИИ для анализа содержимого
3. **Поиск по изображениям**: Поиск по визуальному содержимому
4. **Аннотации**: Добавление комментариев к изображениям
5. **Галерея**: Улучшенный интерфейс для просмотра изображений

## Заключение

Новая функциональность значительно улучшает качество ответов RAG системы, особенно для документов с визуальным контентом. Пользователи теперь могут получать не только текстовые ответы, но и визуальную информацию из документов.
