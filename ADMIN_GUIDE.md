# Руководство администратора

## Содержание
1. [Обзор административных функций](#обзор-административных-функций)
2. [Управление пользователями](#управление-пользователями)
3. [Управление документами](#управление-документами)
4. [Настройка ИИ-системы](#настройка-ии-системы)
5. [Управление библиотекой](#управление-библиотекой)
6. [Система прав доступа](#система-прав-доступа)
7. [Мониторинг системы](#мониторинг-системы)
8. [Резервное копирование](#резервное-копирование)
9. [Устранение неполадок](#устранение-неполадок)

## Обзор административных функций

Как администратор, вы имеете доступ к расширенным функциям системы:

- **Управление пользователями** - создание, редактирование, права доступа
- **Управление документами** - загрузка, организация, категоризация
- **Настройка ИИ-системы** - RAG, веб-поиск, интеграция с Yandex Cloud
- **Управление библиотекой** - теги, категории, поиск
- **Мониторинг системы** - статистика, логи, производительность
- **Техническое обслуживание** - обновления, резервное копирование

## Управление пользователями

### Роли пользователей

Система поддерживает следующие роли:

1. **Администратор** (`role_id = 1`) - полный доступ ко всем функциям
2. **Пользователь** (`role_id = 2`) - ограниченный доступ согласно правам

### Уровни доступа

Иерархическая система уровней доступа:

1. **Уровень 1** - Базовый доступ (стажеры, временные сотрудники)
2. **Уровень 2** - Стандартный доступ (основные сотрудники)
3. **Уровень 3** - Расширенный доступ (старшие сотрудники)

### Принципы доступа

- **Иерархический доступ**: `Content.access_level <= user.access_id`
- **Отдельная изоляция**: `Content.department_id == user.department_id`
- **Административные права**: Админы видят весь контент

### Управление отделами

Каждый пользователь привязан к отделу, что определяет:
- Доступные документы
- Возможности ИИ-ассистента
- Результаты поиска в библиотеке

## Управление документами

### Организация файловой структуры

Рекомендуемая структура папок:
```
ContentForDepartment/
├── 1/ (HR отдел)
│   ├── policies/
│   ├── procedures/
│   └── forms/
├── 2/ (IT отдел)
│   ├── manuals/
│   ├── guides/
│   └── policies/
└── 3/ (Финансы)
    ├── regulations/
    ├── procedures/
    └── reports/
```

### Загрузка документов

**Пошаговый процесс:**

1. **Подготовка документов**
   - Проверьте формат файлов (PDF, DOCX, TXT, DOC, PPT, PPTX, XLS, XLSX, RTF)
   - Убедитесь в корректности названий
   - Проверьте размер файлов (до 50 МБ)

2. **Загрузка через интерфейс**
   - Перейдите в "Документы" → "Загрузить файлы"
   - Выберите уровень доступа
   - Укажите отдел
   - Выберите тег (категорию) - опционально
   - Выберите файлы
   - Нажмите "Загрузить"

3. **Проверка загрузки**
   - Используйте поиск для проверки загруженных документов
   - Убедитесь в корректности метаданных

### Редактирование документов

**Возможности редактирования:**
- Изменение названия и описания
- Изменение уровня доступа
- Изменение отдела
- Добавление/удаление тега (категории)

**Важные моменты:**
- При изменении отдела документ становится доступен новому отделу
- При изменении уровня доступа меняется круг пользователей
- Удаление тега делает документ "без категории"

### Контроль качества документов

**Рекомендации:**
- Используйте понятные названия файлов
- Добавляйте подробные описания к документам
- Правильно назначайте теги для категоризации
- Регулярно обновляйте устаревшие документы
- Удаляйте дублирующиеся файлы

## Настройка ИИ-системы

### Интеграция с Yandex Cloud

**Необходимые переменные окружения:**
```bash
YANDEX_API_KEY=your_api_key
YANDEX_FOLDER_ID=your_folder_id
SEARCH_API_API_KEY=your_search_api_key
SEARCH_API_IAM_TOKEN=your_iam_token
```

### Доступные режимы ИИ

1. **Простой чат**
   - Обычная генерация с YandexGPT
   - Поиск в интернете через Yandex Search API

2. **RAG система**
   - Обычный RAG - поиск в корпоративных документах
   - Гибридный RAG - комбинация документов и интернета

### Настройка RAG системы

**Инициализация для нового отдела:**
- Автоматическая обработка при загрузке документов
- Создание эмбеддингов для поиска
- Кэширование в локальном JSON формате

**Мониторинг RAG:**
- Проверка количества обработанных документов
- Контроль качества эмбеддингов
- Отслеживание производительности поиска

### Настройка веб-поиска

**Конфигурация Yandex Search API:**
- Получение API ключей в Yandex Cloud Console
- Настройка IAM токенов для аутентификации
- Тестирование подключения к API

## Управление библиотекой

### Система тегов (категорий)

**Создание тегов:**
1. Перейдите в "Администрирование" → "Теги"
2. Нажмите "Добавить тег"
3. Введите название категории
4. Сохраните

**Назначение тегов документам:**
- При загрузке документа
- При редактировании документа
- Массовое назначение через интерфейс

### Организация библиотеки

**Структура категорий:**
- **Все документы** - полный список
- **Без тега** - документы без категории
- **[Название тега]** - документы конкретной категории

**Рекомендации по категоризации:**
- Используйте понятные названия тегов
- Создавайте логичную иерархию
- Не создавайте слишком много тегов
- Регулярно проверяйте и обновляйте категории

### Поиск в библиотеке

**Возможности поиска:**
- Глобальный поиск по всем документам
- Поиск в рамках категории
- Поддержка поиска с пробелами и подчеркиваниями
- Поиск по названию, описанию и содержимому

## Система прав доступа

### Иерархическая модель

**Принципы работы:**
```
Администратор (role_id = 1)
├── Полный доступ ко всем ресурсам
├── Управление пользователями
├── Управление документами
└── Системные настройки

Пользователь (role_id = 2)
├── Доступ к документам своего отдела
├── Доступ к документам своего уровня и ниже
├── Использование ИИ-ассистента
└── Просмотр библиотеки
```

### Настройка прав доступа

**Для документов:**
- `access_level` - минимальный уровень доступа
- `department_id` - отдел, которому принадлежит документ
- Администраторы видят все документы

**Для пользователей:**
- `access_id` - уровень доступа пользователя
- `department_id` - отдел пользователя
- `role_id` - роль в системе

### Проверка прав доступа

**Формулы проверки:**
```python
# Для обычных пользователей
if user.role_id == 1:  # Администратор
    # Полный доступ
else:  # Обычный пользователь
    # Проверка отдела и уровня доступа
    if (user.department_id == content.department_id and 
        user.access_id >= content.access_level):
        # Доступ разрешен
```

## Мониторинг системы

### Логирование

**Типы логов:**
- Логи аутентификации и авторизации
- Логи загрузки и скачивания файлов
- Логи использования ИИ-системы
- Логи ошибок и исключений

**Мониторинг логов:**
- Регулярная проверка файлов логов
- Настройка алертов на критические ошибки
- Анализ паттернов использования

### Производительность

**Метрики для отслеживания:**
- Время отклика API
- Время загрузки страниц
- Использование памяти и CPU
- Количество одновременных пользователей

**Оптимизация:**
- Мониторинг медленных запросов
- Оптимизация запросов к базе данных
- Кэширование часто используемых данных

### Безопасность

**Мониторинг безопасности:**
- Попытки несанкционированного доступа
- Подозрительная активность пользователей
- Ошибки аутентификации
- Попытки загрузки вредоносных файлов

## Резервное копирование

### Стратегия резервного копирования

**Ежедневные бэкапы:**
```bash
# Бэкап базы данных
mysqldump -u root -p database_name > backup_$(date +%Y%m%d).sql

# Бэкап файлов
tar -czf files_backup_$(date +%Y%m%d).tar.gz /app/files/

# Бэкап конфигурации
tar -czf config_backup_$(date +%Y%m%d).tar.gz /app/config/
```

**Еженедельные бэкапы:**
- Полный бэкап системы
- Проверка целостности бэкапов
- Тестирование восстановления

### Восстановление системы

**Процедура восстановления:**
1. Остановка системы
2. Восстановление базы данных
3. Восстановление файлов
4. Проверка целостности
5. Запуск системы

**Тестирование восстановления:**
- Регулярное тестирование процедуры восстановления
- Документирование всех шагов
- Обучение персонала

## Устранение неполадок

### Частые проблемы

**Ошибка 422 при редактировании контента:**
- Проблема: Неправильная валидация `tag_id`
- Решение: Проверьте, что `tag_id` может быть `null`

**Ошибки доступа к библиотеке:**
- Проблема: Неправильная проверка прав доступа
- Решение: Проверьте настройки отдела и уровня доступа

**Проблемы с веб-поиском:**
- Проблема: Неверные API ключи Yandex
- Решение: Проверьте переменные окружения

### Диагностика проблем

**Проверка логов:**
```bash
# Просмотр логов приложения
docker logs local-llm-with-rag-backend-1

# Просмотр логов базы данных
docker logs local-llm-with-rag-db-1
```

**Проверка подключений:**
```bash
# Проверка подключения к БД
docker exec -it local-llm-with-rag-backend-1 python -c "
from database import get_db
db = next(get_db())
print('Database connection OK')
"
```

**Проверка API:**
```bash
# Проверка доступности API
curl http://localhost:8082/health
```

### Профилактические меры

**Регулярные проверки:**
- Ежедневная проверка логов
- Еженедельная проверка производительности
- Ежемесячная проверка безопасности

**Обновления системы:**
- Регулярное обновление зависимостей
- Мониторинг уязвимостей
- Тестирование обновлений в dev-среде

---

*Документ обновлен: 13.08.2025*
*Версия системы: 2.0*