# Улучшения системы работы с изображениями

## Обзор изменений

Система RAG была значительно улучшена для более интеллектуальной работы с изображениями. Теперь изображения связываются с текстом логически, а не просто добавляются все подряд.

## Основные улучшения

### 1. Улучшенный алгоритм извлечения контекста изображений

**Файл:** `server/utils/image_extractor.py`

#### Новые возможности:
- **Точное определение контекста**: Алгоритм теперь находит текст, который действительно относится к изображению
- **Вычисление расстояния**: Используется евклидово расстояние между изображением и текстом для определения близости
- **Умная фильтрация**: Игнорируются слишком короткие или нерелевантные тексты
- **Поиск информативных предложений**: Система ищет предложения с ключевыми словами об изображениях

#### Алгоритм работы:
```python
def _find_image_context_improved(self, page, img_index: int, chunk_text: str) -> str:
    # 1. Получаем структуру страницы
    # 2. Разделяем блоки на изображения и текст
    # 3. Вычисляем расстояние между изображением и текстом
    # 4. Собираем близкий текст (в пределах 100 пикселей)
    # 5. Сортируем по расстоянию и важности
    # 6. Возвращаем наиболее релевантный контекст
```

### 2. Система оценки релевантности изображений

**Новая функция:** `_calculate_image_relevance()`

#### Принцип работы:
- **Jaccard similarity**: Вычисляется пересечение слов между контекстом изображения и текстом чанка
- **Дополнительные факторы**:
  - Длина контекста (предпочтение более длинному контексту)
  - Наличие ключевых слов об изображениях (диаграмма, график, схема и т.д.)
  - Наличие цифр (часто указывает на графики/диаграммы)

#### Формула релевантности:
```
relevance = jaccard_similarity * 0.6 + context_length_factor * 0.2 + keyword_bonus + number_bonus
```

### 3. Фильтрация изображений по релевантности

**Функция:** `get_images_for_chunk()`

#### Критерии фильтрации:
- **Порог релевантности**: Показываются только изображения с релевантностью > 0.1
- **Сортировка**: Изображения сортируются по убыванию релевантности
- **Ограничение количества**: Максимум 3 изображения на чанк

### 4. Улучшенный промпт для ИИ

**Файл:** `server/yandex_rag_service.py`

#### Новые правила для ИИ:
```
### ПРАВИЛА РАБОТЫ С ИЗОБРАЖЕНИЯМИ:
17. В документах найдено {total_images} изображений - обязательно упомяни об этом в ответе
18. Если изображения релевантны к вопросу - опиши их содержание на основе контекста
19. Указывай, в каком источнике находятся изображения (например: "В источнике 1 есть диаграмма...")
20. Если изображения содержат графики, диаграммы, схемы - обязательно упомяни об этом
21. Используй контекст изображений для более полного ответа
```

#### Информация об изображениях в промпте:
```
### ИНФОРМАЦИЯ ОБ ИЗОБРАЖЕНИЯХ:
Источник 1 (document.pdf):
- Изображение 1: Диаграмма продаж за 2023 год показывает рост... (релевантность: 0.85)
- Изображение 2: График эффективности отдела... (релевантность: 0.72)
```

### 5. Улучшенный интерфейс отображения

**Файл:** `vite-soft-ui-dashboard-main/src/components/ImageDisplay.vue`

#### Новые возможности:
- **Индикатор релевантности**: Показывает процент релевантности каждого изображения
- **Цветовая кодировка**: 
  - Зеленый (≥70%): Высокая релевантность
  - Желтый (40-69%): Средняя релевантность
  - Серый (<40%): Низкая релевантность
- **Предварительный просмотр контекста**: Показывает краткое описание контекста изображения
- **Детальная информация в модальном окне**: Полная информация о релевантности и контексте

## Технические детали

### Структура данных изображения

```json
{
  "type": "pdf_image",
  "page": 1,
  "index": 0,
  "data": "data:image/png;base64,...",
  "context": "Диаграмма показывает рост продаж...",
  "relevance_score": 0.85,
  "file_path": "/path/to/document.pdf"
}
```

### Новые поля:
- `relevance_score`: Оценка релевантности (0.0 - 1.0)
- `context`: Улучшенный контекст изображения

### Алгоритм вычисления расстояния

```python
def _calculate_distance(self, bbox1, bbox2) -> float:
    # Центры bounding box
    center1_x = (bbox1[0] + bbox1[2]) / 2
    center1_y = (bbox1[1] + bbox1[3]) / 2
    center2_x = (bbox2[0] + bbox2[2]) / 2
    center2_y = (bbox2[1] + bbox2[3]) / 2
    
    # Евклидово расстояние
    distance = ((center1_x - center2_x) ** 2 + (center1_y - center2_y) ** 2) ** 0.5
    return distance
```

## Миграция данных

### Файл: `server/migrations/add_relevance_to_images.py`

Миграция добавляет поле `relevance_score` к существующим изображениям:
- Значение по умолчанию: 0.5
- Обновляет все существующие записи в таблице `document_chunks`

## Результаты улучшений

### До улучшений:
- ❌ Все изображения из документа добавлялись в ответ
- ❌ Нет связи между текстом и изображениями
- ❌ ИИ не понимал контекст изображений
- ❌ Пользователь видел нерелевантные изображения

### После улучшений:
- ✅ Только релевантные изображения показываются в ответе
- ✅ Логическая связь между текстом и изображениями
- ✅ ИИ понимает контекст и описывает изображения
- ✅ Пользователь видит только полезные изображения с оценкой релевантности

## Примеры использования

### Запрос: "Покажи диаграммы из документа"

**До:** Показывались все изображения из документа без разбора

**После:** 
- Система находит изображения с контекстом, содержащим слова "диаграмма", "график"
- Вычисляет релевантность каждого изображения
- Показывает только изображения с релевантностью > 0.1
- ИИ описывает найденные диаграммы на основе их контекста

### Запрос: "Какие схемы есть в документах?"

**Результат:**
- Находятся изображения с контекстом о схемах
- Отображаются с индикатором релевантности
- ИИ упоминает: "В источнике 1 есть схема архитектуры системы (релевантность 87%)"

## Производительность

### Оптимизации:
- Фильтрация изображений на уровне извлечения
- Ограничение количества изображений на чанк
- Кэширование результатов вычисления релевантности

### Влияние на производительность:
- Минимальное: вычисление релевантности происходит только при извлечении изображений
- Улучшение UX: пользователь видит только релевантные изображения

## Будущие улучшения

1. **Машинное обучение**: Использование ML моделей для более точной оценки релевантности
2. **Анализ содержимого изображений**: OCR для извлечения текста из изображений
3. **Семантический поиск**: Поиск изображений по их содержанию
4. **Группировка изображений**: Объединение связанных изображений
5. **Аннотации**: Автоматическое создание описаний изображений
